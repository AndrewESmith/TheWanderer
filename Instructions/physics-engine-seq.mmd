sequenceDiagram
  participant GameState
  participant Phys as PhysicsEngine
  participant BSM as BoulderStateManager

  GameState->>Phys: simulatePhysicsStepWithState(maze, BSM, moveNum, arrows)
  Phys->>Phys: simulateGravityWithState(maze, BSM, moveNum)
  Phys->>BSM: getTriggeredBouldersForMove(BSM, moveNum)
  Phys-->>Phys: triggeredBoulders
  loop for each moving boulder (bottom->top)
    Phys->>Phys: simulateEnhancedBoulderFall()
    alt moved
      Phys-->>Phys: update newMaze, positionUpdates
    else stopped
      Phys-->>Phys: completedBoulders += pos
    end
  end
  Phys-->>GameState: gravityResult (newMaze, events, positions, moving/stopped)
  Phys->>Phys: simulateArrows(newMaze, arrows)
  Phys-->>GameState: combined PhysicsSimulationResult



